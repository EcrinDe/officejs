(function(scope,hex_md5){"use strict";var localstorage;if(typeof localStorage!=="undefined"){localstorage={getItem:function(item){var value=localStorage.getItem(item);return value===null?null:JSON.parse(value)},setItem:function(item,value){return localStorage.setItem(item,JSON.stringify(value))},removeItem:function(item){delete localStorage[item]},clone:function(){return JSON.parse(JSON.stringify(localStorage))}}}else{(function(){var pseudo_localStorage={};localstorage={getItem:function(item){var value=pseudo_localStorage[item];return value===undefined?null:JSON.parse(pseudo_localStorage[item])},setItem:function(item,value){pseudo_localStorage[item]=JSON.stringify(value)},removeItem:function(item){delete pseudo_localStorage[item]},clone:function(){return JSON.parse(JSON.stringify(pseudo_localStorage))}}})()}var jioException=function(spec,my){var that={};spec=spec||{};my=my||{};that.name="jioException";that.message=spec.message||"Unknown Reason.";that.toString=function(){return that.name+": "+that.message};return that};var invalidCommandState=function(spec,my){var that=jioException(spec,my),command=spec.command;spec=spec||{};that.name="invalidCommandState";that.toString=function(){return that.name+": "+command.getLabel()+", "+that.message};return that};var invalidStorage=function(spec,my){var that=jioException(spec,my),type=spec.storage.getType();spec=spec||{};that.name="invalidStorage";that.toString=function(){return that.name+": "+'Type "'+type+'", '+that.message};return that};var invalidStorageType=function(spec,my){var that=jioException(spec,my),type=spec.type;that.name="invalidStorageType";that.toString=function(){return that.name+": "+type+", "+that.message};return that};var jobNotReadyException=function(spec,my){var that=jioException(spec,my);that.name="jobNotReadyException";return that};var tooMuchTriesJobException=function(spec,my){var that=jioException(spec,my);that.name="tooMuchTriesJobException";return that};var invalidJobException=function(spec,my){var that=jioException(spec,my);that.name="invalidJobException";return that};var jio=function(spec){var storage=function(spec,my){var that={},priv={};spec=spec||{};my=my||{};priv.type=spec.type||"";Object.defineProperty(that,"getType",{configurable:false,enumerable:false,writable:false,value:function(){return priv.type}});that.execute=function(command){that.success=command.success;that.error=command.error;that.retry=command.retry;that.end=command.end;if(that.validate(command)){command.executeOn(that)}};that.isValid=function(){return true};that.validate=function(){var mess=that.validateState();if(mess){that.error({status:0,statusText:"Invalid Storage",error:"invalid_storage",message:mess,reason:mess});return false}return true};that.serialized=function(){var o=that.specToStore()||{};o.type=that.getType();return o};that.specToStore=function(){return{}};that.validateState=function(){return""};that.post=function(){setTimeout(function(){that.error({status:0,statusText:"Not Implemented",error:"not_implemented",message:'"Post" command is not implemented',reason:"Command not implemented"})})};that.put=function(){setTimeout(function(){that.error({status:0,statusText:"Not Implemented",error:"not_implemented",message:'"Put" command is not implemented',reason:"Command not implemented"})})};that.putAttachment=function(){setTimeout(function(){that.error({status:0,statusText:"Not Implemented",error:"not_implemented",message:'"PutAttachment" command is not implemented',reason:"Command not implemented"})})};that.get=function(){setTimeout(function(){that.error({status:0,statusText:"Not Implemented",error:"not_implemented",message:'"Get" command is not implemented',reason:"Command not implemented"})})};that.allDocs=function(){setTimeout(function(){that.error({status:0,statusText:"Not Implemented",error:"not_implemented",message:'"AllDocs" command is not implemented',reason:"Command not implemented"})})};that.remove=function(){setTimeout(function(){that.error({status:0,statusText:"Not Implemented",error:"not_implemented",message:'"Remove" command is not implemented',reason:"Command not implemented"})})};that.check=function(command){setTimeout(function(){that.success({ok:true,id:command.getDocId()})})};that.repair=function(command){setTimeout(function(){that.success({ok:true,id:command.getDocId()})})};that.success=function(){};that.retry=function(){};that.error=function(){};that.end=function(){};priv.newCommand=function(method,spec){var o=spec||{};o.label=method;return command(o,my)};priv.storage=my.storage;delete my.storage;that.addJob=function(method,storage_spec,doc,option,success,error){var command_opt={doc:doc,options:option,callbacks:{success:success,error:error}};jobManager.addJob(job({storage:priv.storage(storage_spec||{}),command:priv.newCommand(method,command_opt)},my))};return that};var allDocsCommand=function(spec,my){var that=command(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"allDocs"};that.executeOn=function(storage){storage.allDocs(that)};that.canBeRestored=function(){return false};that.validateState=function(){return true};return that};var checkCommand=function(spec,my){var that=command(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"check"};that.validateState=function(){if(!(typeof that.getDocId()==="string"&&that.getDocId()!=="")){that.error({status:20,statusText:"Document Id Required",error:"document_id_required",message:"The document id is not provided",reason:"Document id is undefined"});return false}return true};that.executeOn=function(storage){storage.check(that)};that.canBeRestored=function(){return false};return that};var command=function(spec,my){var that={},priv={};spec=spec||{};my=my||{};priv.commandlist={post:postCommand,put:putCommand,get:getCommand,remove:removeCommand,allDocs:allDocsCommand,getAttachment:getAttachmentCommand,putAttachment:putAttachmentCommand,removeAttachment:removeAttachmentCommand,check:checkCommand,repair:repairCommand};if(spec.label&&priv.commandlist[spec.label]){priv.label=spec.label;delete spec.label;return priv.commandlist[priv.label](spec,my)}priv.tried=0;priv.doc=spec.doc||{};if(typeof priv.doc!=="object"){priv.doc={_id:priv.doc.toString()}}priv.option=spec.options||{};priv.callbacks=spec.callbacks||{};priv.success=[priv.callbacks.success||function(){}];priv.error=[priv.callbacks.error||function(){}];priv.retry=function(){that.error({status:13,statusText:"Fail Retry",error:"fail_retry",message:"Impossible to retry.",reason:"Impossible to retry."})};priv.end=function(){};priv.on_going=false;that.serialized=function(){var o={};o.label=that.getLabel();o.tried=priv.tried;o.doc=that.cloneDoc();o.option=that.cloneOption();return o};that.getLabel=function(){return"command"};that.getDocId=function(){return priv.doc._id};that.getAttachmentId=function(){return priv.doc._attachment};that.getAttachmentData=function(){return priv.doc._data||""};that.getAttachmentLength=function(){return(priv.doc._data||"").length};that.getAttachmentMimeType=function(){return priv.doc._mimetype};that.md5SumAttachmentData=function(){return hex_md5(priv.doc._data||"")};that.getDocInfo=function(infoname){return priv.doc[infoname]};that.getOption=function(optionname){return priv.option[optionname]};that.validate=function(storage){if(typeof priv.doc._id==="string"&&!priv.doc._id.match("^[^/]+([/][^/]+)?$")){that.error({status:21,statusText:"Invalid Document Id",error:"invalid_document_id",message:'The document id must be like "abc" or "abc/def".',reason:'The document id is no like "abc" or "abc/def"'});return false}if(!that.validateState()){return false}return storage.validate()};that.validateState=function(){return true};that.canBeRetried=function(){return priv.option.max_retry===undefined||priv.option.max_retry===0||priv.tried<priv.option.max_retry};that.getTried=function(){return priv.tried};that.execute=function(storage){if(!priv.on_going){if(that.validate(storage)){priv.tried+=1;priv.on_going=true;storage.execute(that)}}};that.executeOn=function(storage){};that.success=function(return_value){var i;priv.on_going=false;for(i=0;i<priv.success.length;i+=1){priv.success[i](return_value)}priv.end(doneStatus());priv.success=[];priv.error=[]};that.retry=function(return_error){priv.on_going=false;if(that.canBeRetried()){priv.retry()}else{that.error(return_error)}};that.error=function(return_error){var i;priv.on_going=false;for(i=0;i<priv.error.length;i+=1){priv.error[i](return_error)}priv.end(failStatus());priv.success=[];priv.error=[]};that.end=function(){priv.end(doneStatus())};that.addCallbacks=function(success,error){if(arguments.length>1){priv.success.push(success||function(){});priv.error.push(error||function(){})}else{priv.success.push(function(response){(success||function(){})(undefined,response)});priv.error.push(function(err){(success||function(){})(err,undefined)})}};that.onSuccessDo=function(fun){if(fun){priv.success=fun}else{return priv.success}};that.onErrorDo=function(fun){if(fun){priv.error=fun}else{return priv.error}};that.onEndDo=function(fun){priv.end=fun};that.onRetryDo=function(fun){priv.retry=fun};that.canBeRestored=function(){return true};that.clone=function(){return command(that.serialized(),my)};that.cloneOption=function(){return JSON.parse(JSON.stringify(priv.option))};that.cloneDoc=function(){return JSON.parse(JSON.stringify(priv.doc))};return that};var getAttachmentCommand=function(spec,my){var that=command(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"getAttachment"};that.executeOn=function(storage){storage.getAttachment(that)};that.validateState=function(){if(!(typeof that.getDocId()==="string"&&that.getDocId()!=="")){that.error({status:20,statusText:"Document Id Required",error:"document_id_required",message:"The document id is not provided",reason:"Document id is undefined"});return false}if(typeof that.getAttachmentId()!=="string"){that.error({status:22,statusText:"Attachment Id Required",error:"attachment_id_required",message:"The attachment id must be set",reason:"Attachment id not set"});return false}if(that.getAttachmentId()===""){that.error({status:23,statusText:"Invalid Attachment Id",error:"invalid_attachment_id",message:"The attachment id must not be an empty string",reason:"Attachment id is empty"})}return true};return that};var getCommand=function(spec,my){var that=command(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"get"};that.validateState=function(){if(!(typeof that.getDocId()==="string"&&that.getDocId()!=="")){that.error({status:20,statusText:"Document Id Required",error:"document_id_required",message:"The document id is not provided",reason:"Document id is undefined"});return false}return true};that.executeOn=function(storage){storage.get(that)};that.canBeRestored=function(){return false};return that};var postCommand=function(spec,my){var that=command(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"post"};that.validateState=function(){return true};that.executeOn=function(storage){storage.post(that)};return that};var putAttachmentCommand=function(spec,my){var that=command(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"putAttachment"};that.executeOn=function(storage){storage.putAttachment(that)};that.validateState=function(){if(!(typeof that.getDocId()==="string"&&that.getDocId()!=="")){that.error({status:20,statusText:"Document Id Required",error:"document_id_required",message:"The document id is not provided",reason:"Document id is undefined"});return false}if(typeof that.getAttachmentId()!=="string"){that.error({status:22,statusText:"Attachment Id Required",error:"attachment_id_required",message:"The attachment id must be set",reason:"Attachment id not set"});return false}if(that.getAttachmentId()===""){that.error({status:23,statusText:"Invalid Attachment Id",error:"invalid_attachment_id",message:"The attachment id must not be an empty string",reason:"Attachment id is empty"})}return true};return that};var putCommand=function(spec,my){var that=command(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"put"};that.validateState=function(){if(!(typeof that.getDocId()==="string"&&that.getDocId()!=="")){that.error({status:20,statusText:"Document Id Required",error:"document_id_required",message:"The document id is not provided",reason:"Document id is undefined"});return false}return true};that.executeOn=function(storage){storage.put(that)};return that};var removeAttachmentCommand=function(spec,my){var that=command(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"removeAttachment"};that.executeOn=function(storage){storage.removeAttachment(that)};that.validateState=function(){if(!(typeof that.getDocId()==="string"&&that.getDocId()!=="")){that.error({status:20,statusText:"Document Id Required",error:"document_id_required",message:"The document id is not provided",reason:"Document id is undefined"});return false}if(typeof that.getAttachmentId()!=="string"){that.error({status:22,statusText:"Attachment Id Required",error:"attachment_id_required",message:"The attachment id must be set",reason:"Attachment id not set"});return false}if(that.getAttachmentId()===""){that.error({status:23,statusText:"Invalid Attachment Id",error:"invalid_attachment_id",message:"The attachment id must not be an empty string",reason:"Attachment id is empty"})}return true};return that};var removeCommand=function(spec,my){var that=command(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"remove"};that.validateState=function(){if(!(typeof that.getDocId()==="string"&&that.getDocId()!=="")){that.error({status:20,statusText:"Document Id Required",error:"document_id_required",message:"The document id is not provided",reason:"Document id is undefined"});return false}return true};that.executeOn=function(storage){storage.remove(that)};return that};var repairCommand=function(spec,my){var that=command(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"repair"};that.validateState=function(){if(!(typeof that.getDocId()==="string"&&that.getDocId()!=="")){that.error({status:20,statusText:"Document Id Required",error:"document_id_required",message:"The document id is not provided",reason:"Document id is undefined"});return false}return true};that.executeOn=function(storage){storage.repair(that)};return that};var doneStatus=function(spec,my){var that=jobStatus(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"done"};that.canStart=function(){return false};that.canRestart=function(){return false};that.isDone=function(){return true};return that};var failStatus=function(spec,my){var that=jobStatus(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"fail"};that.canStart=function(){return false};that.canRestart=function(){return true};return that};var initialStatus=function(spec,my){var that=jobStatus(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"initial"};that.canStart=function(){return true};that.canRestart=function(){return true};return that};var jobStatus=function(spec,my){var that={};spec=spec||{};my=my||{};that.getLabel=function(){return"job status"};that.canStart=function(){};that.canRestart=function(){};that.serialized=function(){return{label:that.getLabel()}};that.isWaitStatus=function(){return false};that.isDone=function(){return false};return that};var onGoingStatus=function(spec,my){var that=jobStatus(spec,my);spec=spec||{};my=my||{};that.getLabel=function(){return"on going"};that.canStart=function(){return false};that.canRestart=function(){return false};return that};var waitStatus=function(spec,my){var that=jobStatus(spec,my),priv={};spec=spec||{};my=my||{};priv.job_id_array=spec.job_id_array||[];priv.threshold=0;that.getLabel=function(){return"wait"};priv.refreshJobIdArray=function(){var tmp_job_id_array=[],i;for(i=0;i<priv.job_id_array.length;i+=1){if(jobManager.jobIdExists(priv.job_id_array[i])){tmp_job_id_array.push(priv.job_id_array[i])}}priv.job_id_array=tmp_job_id_array};that.waitForJob=function(job){var i;for(i=0;i<priv.job_id_array.length;i+=1){if(priv.job_id_array[i]===job.getId()){return}}priv.job_id_array.push(job.getId())};that.dontWaitForJob=function(job){var i,tmp_job_id_array=[];for(i=0;i<priv.job_id_array.length;i+=1){if(priv.job_id_array[i]!==job.getId()){tmp_job_id_array.push(priv.job_id_array[i])}}priv.job_id_array=tmp_job_id_array};that.waitForTime=function(ms){priv.threshold=Date.now()+ms};that.stopWaitForTime=function(){priv.threshold=0};that.canStart=function(){priv.refreshJobIdArray();return priv.job_id_array.length===0&&Date.now()>=priv.threshold};that.canRestart=function(){return that.canStart()};that.serialized=function(){return{label:that.getLabel(),waitfortime:priv.threshold,waitforjob:priv.job_id_array}};that.isWaitStatus=function(){return true};return that};var job=function(spec){var that={},priv={};spec=spec||{};priv.id=jobIdHandler.nextId();priv.command=spec.command;priv.storage=spec.storage;priv.status=initialStatus();priv.date=new Date;if(!priv.storage){throw invalidJobException({job:that,message:"No storage set"})}if(!priv.command){throw invalidJobException({job:that,message:"No command set"})}that.getCommand=function(){return priv.command};that.getStatus=function(){return priv.status};that.getId=function(){return priv.id};that.getStorage=function(){return priv.storage};that.getDate=function(){return priv.date};that.isReady=function(){if(priv.command.getTried()===0){return priv.status.canStart()}return priv.status.canRestart()};that.serialized=function(){return{id:priv.id,date:priv.date.getTime(),status:priv.status.serialized(),command:priv.command.serialized(),storage:priv.storage.serialized()}};that.waitForJob=function(job){if(priv.status.getLabel()!=="wait"){priv.status=waitStatus({})}priv.status.waitForJob(job)};that.dontWaitFor=function(job){if(priv.status.getLabel()==="wait"){priv.status.dontWaitForJob(job)}};that.waitForTime=function(ms){if(priv.status.getLabel()!=="wait"){priv.status=waitStatus({})}priv.status.waitForTime(ms)};that.stopWaitForTime=function(){if(priv.status.getLabel()==="wait"){priv.status.stopWaitForTime()}};that.eliminated=function(){priv.command.error({status:10,statusText:"Stopped",error:"stopped",message:"This job has been stopped by another one.",reason:"this job has been stopped by another one"})};that.notAccepted=function(){priv.command.onEndDo(function(){priv.status=failStatus();jobManager.terminateJob(that)});priv.command.error({status:11,statusText:"Not Accepted",error:"not_accepted",message:"This job is already running.",reason:"this job is already running"})};that.update=function(job){priv.command.addCallbacks(job.getCommand().onSuccessDo()[0],job.getCommand().onErrorDo()[0]);priv.date=new Date(job.getDate().getTime())};that.execute=function(){if(!that.getCommand().canBeRetried()){throw tooMuchTriesJobException({job:that,message:"The job was invoked too much time."})}if(!that.isReady()){throw jobNotReadyException({job:that,message:"Can not execute this job."})}priv.status=onGoingStatus();priv.command.onRetryDo(function(){var ms=priv.command.getTried();ms=ms*ms*200;if(ms>1e4){ms=1e4}that.waitForTime(ms)});priv.command.onEndDo(function(status){priv.status=status;jobManager.terminateJob(that)});priv.command.execute(priv.storage)};return that};var announcement=function(spec,my){var that={},callback_a=[],announcer=spec.announcer||{};spec=spec||{};my=my||{};that.add=function(callback){callback_a.push(callback)};that.remove=function(callback){var i,tmp_callback_a=[];for(i=0;i<callback_a.length;i+=1){if(callback_a[i]!==callback){tmp_callback_a.push(callback_a[i])}}callback_a=tmp_callback_a};that.register=function(){announcer.register(that)};that.unregister=function(){announcer.unregister(that)};that.trigger=function(args){var i;for(i=0;i<callback_a.length;i+=1){callback_a[i].apply(null,args)}};return that};var activityUpdater=function(spec,my){var that={},priv={};spec=spec||{};my=my||{};priv.id=spec.id||0;priv.interval=400;priv.interval_id=null;priv.touch=function(){localstorage.setItem("jio/id/"+priv.id,Date.now())};that.setId=function(id){priv.id=id};that.setIntervalDelay=function(ms){priv.interval=ms};that.getIntervalDelay=function(){return priv.interval};that.start=function(){if(!priv.interval_id){priv.touch();priv.interval_id=setInterval(function(){priv.touch()},priv.interval)}};that.stop=function(){if(priv.interval_id!==null){clearInterval(priv.interval_id);priv.interval_id=null}};return that}();var announcer=function(spec,my){var that={},announcement_o={};spec=spec||{};my=my||{};that.register=function(name){if(!announcement_o[name]){announcement_o[name]=announcement()}};that.unregister=function(name){if(announcement_o[name]){delete announcement_o[name]}};that.at=function(name){return announcement_o[name]};that.on=function(name,callback){that.register(name);that.at(name).add(callback)};that.trigger=function(name,args){that.at(name).trigger(args)};return that}();var jobIdHandler=function(spec){var that={},id=0;spec=spec||{};that.nextId=function(){id=id+1;return id};return that}();var jobManager=function(spec){var that={},job_array_name="jio/job_array",priv={};spec=spec||{};priv.id=spec.id;priv.interval_id=null;priv.interval=200;priv.job_array=[];priv.getJobArrayName=function(){return job_array_name+"/"+priv.id};priv.getJobArray=function(){return localstorage.getItem(priv.getJobArrayName())||[]};priv.copyJobArrayToLocal=function(){var new_a=[],i;for(i=0;i<priv.job_array.length;i+=1){new_a.push(priv.job_array[i].serialized())}localstorage.setItem(priv.getJobArrayName(),new_a)};priv.removeJob=function(job){var i,tmp_job_array=[];for(i=0;i<priv.job_array.length;i+=1){if(priv.job_array[i]!==job){tmp_job_array.push(priv.job_array[i])}}priv.job_array=tmp_job_array;priv.copyJobArrayToLocal()};that.setId=function(id){priv.id=id};that.start=function(){var i;if(priv.interval_id===null){priv.interval_id=setInterval(function(){priv.restoreOldJio();for(i=0;i<priv.job_array.length;i+=1){that.execute(priv.job_array[i])}},priv.interval)}};that.stop=function(){if(priv.interval_id!==null){clearInterval(priv.interval_id);priv.interval_id=null;if(priv.job_array.length===0){localstorage.removeItem(priv.getJobArrayName())}}};priv.restoreOldJio=function(){var i,jio_id_a;priv.lastrestore=priv.lastrestore||0;if(priv.lastrestore>Date.now()-2e3){return}jio_id_a=localstorage.getItem("jio/id_array")||[];for(i=0;i<jio_id_a.length;i+=1){priv.restoreOldJioId(jio_id_a[i])}priv.lastrestore=Date.now()};priv.restoreOldJioId=function(id){var jio_date;jio_date=localstorage.getItem("jio/id/"+id)||0;if(new Date(jio_date).getTime()<Date.now()-1e4){priv.restoreOldJobFromJioId(id);priv.removeOldJioId(id);priv.removeJobArrayFromJioId(id)}};priv.restoreOldJobFromJioId=function(id){var i,command_object,jio_job_array;jio_job_array=localstorage.getItem("jio/job_array/"+id)||[];for(i=0;i<jio_job_array.length;i+=1){command_object=command(jio_job_array[i].command);if(command_object.canBeRestored()){that.addJob(job({storage:that.storage(jio_job_array[i].storage),command:command_object}))}}};priv.removeOldJioId=function(id){var i,jio_id_array,new_array=[];jio_id_array=localstorage.getItem("jio/id_array")||[];for(i=0;i<jio_id_array.length;i+=1){if(jio_id_array[i]!==id){new_array.push(jio_id_array[i])}}localstorage.setItem("jio/id_array",new_array);localstorage.removeItem("jio/id/"+id)};priv.removeJobArrayFromJioId=function(id){localstorage.removeItem("jio/job_array/"+id)};that.execute=function(job){try{job.execute()}catch(e){switch(e.name){case"jobNotReadyException":break;case"tooMuchTriesJobException":break;default:throw e}}priv.copyJobArrayToLocal()};that.jobIdExists=function(id){var i;for(i=0;i<priv.job_array.length;i+=1){if(priv.job_array[i].getId()===id){return true}}return false};that.terminateJob=function(job){priv.removeJob(job)};that.addJob=function(job){var result_array=that.validateJobAccordingToJobList(priv.job_array,job);priv.appendJob(job,result_array)};that.validateJobAccordingToJobList=function(job_array,job){var i,result_array=[];for(i=0;i<job_array.length;i+=1){result_array.push(jobRules.validateJobAccordingToJob(job_array[i],job))}return result_array};priv.appendJob=function(job,result_array){var i;if(priv.job_array.length!==result_array.length){throw new RangeError("Array out of bound")}for(i=0;i<result_array.length;i+=1){if(result_array[i].action==="dont accept"){return job.notAccepted()}}for(i=0;i<result_array.length;i+=1){switch(result_array[i].action){case"eliminate":result_array[i].job.eliminated();priv.removeJob(result_array[i].job);break;case"update":result_array[i].job.update(job);priv.copyJobArrayToLocal();return;case"wait":job.waitForJob(result_array[i].job);break;default:break}}priv.job_array.push(job);priv.copyJobArrayToLocal()};that.serialized=function(){var a=[],i,job_array=priv.job_array||[];for(i=0;i<job_array.length;i+=1){a.push(job_array[i].serialized())}return a};return that}();var jobRules=function(){var that={},priv={};priv.compare={};priv.action={};Object.defineProperty(that,"eliminate",{configurable:false,enumerable:false,writable:false,value:function(){return"eliminate"}});Object.defineProperty(that,"update",{configurable:false,enumerable:false,writable:false,value:function(){return"update"}});Object.defineProperty(that,"dontAccept",{configurable:false,enumerable:false,writable:false,value:function(){return"dont accept"}});Object.defineProperty(that,"wait",{configurable:false,enumerable:false,writable:false,value:function(){return"wait"}});Object.defineProperty(that,"ok",{configurable:false,enumerable:false,writable:false,value:function(){return"none"}});that.default_action=that.ok;that.default_compare=function(job1,job2){return job1.getId()!==job2.getId()&&job1.getStatus().getLabel()!=="done"&&job1.getStatus().getLabel()!=="fail"&&JSON.stringify(job1.getStorage().serialized())===JSON.stringify(job2.getStorage().serialized())};Object.defineProperty(that,"sameDocumentId",{configurable:false,enumerable:false,writable:false,value:function(job1,job2){return job1.getCommand().getDocId()===job2.getCommand().getDocId()}});Object.defineProperty(that,"sameRevision",{configurable:false,enumerable:false,writable:false,value:function(job1,job2){return job1.getCommand().getDocInfo("_rev")===job2.getCommand().getDocInfo("_rev")}});Object.defineProperty(that,"sameAttachmentId",{configurable:false,enumerable:false,writable:false,value:function(job1,job2){return job1.getCommand().getAttachmentId()===job2.getCommand().getAttachmentId()}});Object.defineProperty(that,"sameDocument",{configurable:false,enumerable:false,writable:false,value:function(job1,job2){return JSON.stringify(job1.getCommand().cloneDoc())===JSON.stringify(job2.getCommand().cloneDoc())}});Object.defineProperty(that,"sameOption",{configurable:false,enumerable:false,writable:false,value:function(job1,job2){return JSON.stringify(job1.getCommand().cloneOption())===JSON.stringify(job2.getCommand().cloneOption())}});priv.getAction=function(job1,job2){var method1,method2,tmp=priv.action,i,j,condition_list=[],res;method1=job1.getCommand().getLabel();method2=job2.getCommand().getLabel();tmp=tmp[method1]=tmp[method1]||{};tmp=tmp[method2]=tmp[method2]||[];for(i=0;i<tmp.length;i+=1){condition_list=tmp[i].condition_list;res=true;for(j=0;j<condition_list.length;j+=1){if(!condition_list[j](job1,job2)){res=false;break}}if(res){return tmp[i].rule()}}return that.default_action()};priv.canCompare=function(job1,job2){var method1,method2;method1=job1.getCommand().getLabel();method2=job2.getCommand().getLabel();if(priv.compare[method1]&&priv.compare[method1][method2]){return priv.compare[method1][method2](job1,job2)}return that.default_compare(job1,job2)};Object.defineProperty(that,"validateJobAccordingToJob",{configurable:false,enumerable:false,writable:false,value:function(job1,job2){if(priv.canCompare(job1,job2)){return{action:priv.getAction(job1,job2),job:job1}}return{action:that.default_action(job1,job2),job:job1}}});Object.defineProperty(that,"addActionRule",{configurable:false,enumerable:false,writable:false,value:function(method1,method2,condition_list,rule){var tmp=priv.action;tmp=tmp[method1]=tmp[method1]||{};tmp=tmp[method2]=tmp[method2]||[];tmp.push({condition_list:condition_list,rule:rule})}});Object.defineProperty(that,"addCompareRule",{configurable:false,enumerable:false,writable:false,value:function(method1,method2,rule){priv.compare[method1]=priv.compare[method1]||{};priv.compare[method1][method2]=rule}});that.addActionRule("post","post",[that.sameDocument],that.update);that.addActionRule("post","post",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("post","put",[that.sameDocument],that.update);that.addActionRule("post","put",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("post","putAttachment",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("post","remove",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("put","post",[that.sameDocument],that.update);that.addActionRule("put","post",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("put","put",[that.sameDocument],that.update);that.addActionRule("put","put",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("put","putAttachment",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("put","remove",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("putAttachment","post",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("putAttachment","put",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("putAttachment","putAttachment",[that.sameDocument],that.update);that.addActionRule("putAttachment","putAttachment",[that.sameDocumentId,that.sameRevision,that.sameAttachmentId],that.wait);that.addActionRule("putAttachment","remove",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("remove","post",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("remove","put",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("remove","putAttachment",[that.sameDocumentId,that.sameRevision],that.wait);that.addActionRule("remove","remove",[that.sameDocumentId,that.sameRevision],that.update);that.addActionRule("get","get",[that.sameDocument,that.sameOption],that.update);that.addActionRule("allDocs","allDocs",[that.sameDocument,that.sameOption],that.update);return that}();var that={},priv={},jio_id_array_name="jio/id_array";spec=spec||{};priv.id=null;priv.storage_spec=spec;priv.environments={};priv.init=function(){if(priv.id===null){var i,jio_id_a=localstorage.getItem(jio_id_array_name)||[];priv.id=1;for(i=0;i<jio_id_a.length;i+=1){if(jio_id_a[i]>=priv.id){priv.id=jio_id_a[i]+1}}jio_id_a.push(priv.id);localstorage.setItem(jio_id_array_name,jio_id_a);activityUpdater.setId(priv.id);jobManager.setId(priv.id)}};Object.defineProperty(that,"storage",{configurable:false,enumerable:false,writable:false,value:function(spec,my,forcetype){var spec_str,type;spec=spec||{};my=my||{};my.basicStorage=storage;spec_str=JSON.stringify(spec);priv.environments[spec_str]=priv.environments[spec_str]||{};my.env=priv.environments[spec_str];my.storage=that.storage;type=forcetype||spec.type||"base";if(type==="base"){return storage(spec,my)}if(!storage_type_object[type]){throw invalidStorageType({type:type,message:"Storage does not exists."})}return storage_type_object[type](spec,my)}});jobManager.storage=that.storage;Object.defineProperty(that,"start",{configurable:false,enumerable:false,writable:false,value:function(){priv.init();activityUpdater.start();jobManager.start()}});Object.defineProperty(that,"stop",{configurable:false,enumerable:false,writable:false,value:function(){jobManager.stop()}});Object.defineProperty(that,"close",{configurable:false,enumerable:false,writable:false,value:function(){activityUpdater.stop();jobManager.stop();priv.id=null}});Object.defineProperty(that,"getId",{configurable:false,enumerable:false,writable:false,value:function(){return priv.id
}});Object.defineProperty(that,"getJobRules",{configurable:false,enumerable:false,writable:false,value:function(){return jobRules}});Object.defineProperty(that,"validateStorageDescription",{configurable:false,enumerable:false,writable:false,value:function(description){return that.storage(description).isValid()}});Object.defineProperty(that,"getJobArray",{configurable:false,enumerable:false,writable:false,value:function(){return jobManager.serialized()}});priv.makeCallbacks=function(param,callback1,callback2){param.callback=function(err,val){if(err){param.error(err)}else{param.success(val)}};param.success=function(val){param.callback(undefined,val)};param.error=function(err){param.callback(err,undefined)};if(typeof callback1==="function"){if(typeof callback2==="function"){param.success=callback1;param.error=callback2}else{param.callback=callback1}}else{param.callback=function(){}}};priv.parametersToObject=function(list,default_options){var k,i=0,callbacks=[],param={options:{}};for(i=0;i<list.length;i+=1){if(typeof list[i]==="object"){param.options=list[i];for(k in default_options){if(typeof default_options[k]!==typeof list[i][k]){param.options[k]=default_options[k]}}}if(typeof list[i]==="function"){callbacks.push(list[i])}}priv.makeCallbacks(param,callbacks[0],callbacks[1]);return param};priv.addJob=function(commandCreator,spec){jobManager.addJob(job({storage:that.storage(priv.storage_spec),command:commandCreator(spec)}))};Object.defineProperty(that,"post",{configurable:false,enumerable:false,writable:false,value:function(doc,options,success,error){var param=priv.parametersToObject([options,success,error],{max_retry:0});priv.addJob(postCommand,{doc:doc,options:param.options,callbacks:{success:param.success,error:param.error}})}});Object.defineProperty(that,"put",{configurable:false,enumerable:false,writable:false,value:function(doc,options,success,error){var param=priv.parametersToObject([options,success,error],{max_retry:0});priv.addJob(putCommand,{doc:doc,options:param.options,callbacks:{success:param.success,error:param.error}})}});Object.defineProperty(that,"get",{configurable:false,enumerable:false,writable:false,value:function(doc,options,success,error){var param=priv.parametersToObject([options,success,error],{max_retry:3});priv.addJob(getCommand,{doc:doc,options:param.options,callbacks:{success:param.success,error:param.error}})}});Object.defineProperty(that,"remove",{configurable:false,enumerable:false,writable:false,value:function(doc,options,success,callback){var param=priv.parametersToObject([options,success,callback],{max_retry:0});priv.addJob(removeCommand,{doc:doc,options:param.options,callbacks:{success:param.success,error:param.error}})}});Object.defineProperty(that,"allDocs",{configurable:false,enumerable:false,writable:false,value:function(options,success,error){var param=priv.parametersToObject([options,success,error],{max_retry:3});priv.addJob(allDocsCommand,{options:param.options,callbacks:{success:param.success,error:param.error}})}});Object.defineProperty(that,"getAttachment",{configurable:false,enumerable:false,writable:false,value:function(doc,options,success,error){var param=priv.parametersToObject([options,success,error],{max_retry:3});priv.addJob(getAttachmentCommand,{doc:doc,options:param.options,callbacks:{success:param.success,error:param.error}})}});Object.defineProperty(that,"putAttachment",{configurable:false,enumerable:false,writable:false,value:function(doc,options,success,error){var param=priv.parametersToObject([options,success,error],{max_retry:0});priv.addJob(putAttachmentCommand,{doc:doc,options:param.options,callbacks:{success:param.success,error:param.error}})}});Object.defineProperty(that,"removeAttachment",{configurable:false,enumerable:false,writable:false,value:function(doc,options,success,error){var param=priv.parametersToObject([options,success,error],{max_retry:0});priv.addJob(removeAttachmentCommand,{doc:doc,options:param.options,callbacks:{success:param.success,error:param.error}})}});Object.defineProperty(that,"check",{configurable:false,enumerable:false,writable:false,value:function(doc,options,success,callback){var param=priv.parametersToObject([options,success,callback],{max_retry:3});priv.addJob(checkCommand,{doc:doc,options:param.options,callbacks:{success:param.success,error:param.error}})}});Object.defineProperty(that,"repair",{configurable:false,enumerable:false,writable:false,value:function(doc,options,success,callback){var param=priv.parametersToObject([options,success,callback],{max_retry:3});priv.addJob(repairCommand,{doc:doc,options:param.options,callbacks:{success:param.success,error:param.error}})}});return that};var storage_type_object={base:function(){}};var jioNamespace=function(spec){var that={};spec=spec||{};Object.defineProperty(that,"newJio",{configurable:false,enumerable:false,writable:false,value:function(spec){var storage=spec,instance=null;if(typeof storage==="string"){storage=JSON.parse(storage)}else{storage=JSON.stringify(storage);if(storage!==undefined){storage=JSON.parse(storage)}}storage=storage||{type:"base"};instance=jio(storage);instance.start();return instance}});Object.defineProperty(that,"addStorageType",{configurable:false,enumerable:false,writable:false,value:function(type,constructor){constructor=constructor||function(){return null};if(storage_type_object[type]){throw invalidStorageType({type:type,message:"Already known."})}storage_type_object[type]=constructor}});return that}();Object.defineProperty(scope,"jIO",{configurable:false,enumerable:false,writable:false,value:jioNamespace})})(window,hex_md5);