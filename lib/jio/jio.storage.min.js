/*! JIO Storage - v0.1.0 - 2012-10-12
* Copyright (c) 2012 Nexedi; Licensed  */
(function(e,t,n,r,i,s){var o=function(t,n){t=t||{};var r=n.basicStorage(t,n),i={};console.log(t),i.secureDocId=function(e){var t=e.split("/"),n;t[0]===""&&(t=t.slice(1));for(n=0;n<t.length;n+=1)if(t[n]==="")return"";return t.join("%2F")},i.convertSlashes=function(e){return e.split("/").join("%2F")},i.restoreSlashes=function(e){return e.split("%2F").join("/")},i.username=t.username||"",i.secured_username=i.convertSlashes(i.username),i.applicationname=t.applicationname||"untitled",i.secured_applicationname=i.convertSlashes(i.applicationname);var s="jio/local_user_array",o="jio/local_file_name_array/"+i.secured_username+"/"+i.secured_applicationname,u=r.serialized;return r.serialized=function(){var e=u();return e.applicationname=i.applicationname,e.username=i.username,e},r.validateState=function(){return i.secured_username?"":'Need at least one parameter: "username".'},i.getUserArray=function(){return e.getItem(s)||[]},i.addUser=function(t){var n=i.getUserArray();n.push(t),e.setItem(s,n)},i.userExists=function(e){var t=i.getUserArray(),n,r;for(n=0,r=t.length;n<r;n+=1)if(t[n]===e)return!0;return!1},i.getFileNameArray=function(){return e.getItem(o)||[]},i.addFileName=function(t){var n=i.getFileNameArray();n.push(t),e.setItem(o,n)},i.removeFileName=function(t){var n,r,s=i.getFileNameArray(),u=[];for(n=0,r=s.length;n<r;n+=1)s[n]!==t&&u.push(s[n]);e.setItem(o,u)},i.checkSecuredDocId=function(e,t,n){return e?!0:(r.error({status:403,statusText:"Method Not Allowed",error:"method_not_allowed",message:"Cannot "+n+' "'+t+'", file name is incorrect.',reason:"Cannot "+n+' "'+t+'", file name is incorrect'}),!1)},r.post=function(e){r.put(e)},r.put=function(t){setTimeout(function(){var n=i.secureDocId(t.getDocId()),s=null,o="jio/local/"+i.secured_username+"/"+i.secured_applicationname+"/"+n;if(!i.checkSecuredDocId(n,t.getDocId(),"put"))return;s=e.getItem(o),s?(s.content=t.getDocContent(),s._last_modified=Date.now()):(s={_id:t.getDocId(),content:t.getDocContent(),_creation_date:Date.now(),_last_modified:Date.now()},i.userExists(i.secured_username)||i.addUser(i.secured_username),i.addFileName(n)),e.setItem(o,s),r.success({ok:!0,id:t.getDocId()})})},r.get=function(t){setTimeout(function(){var n=i.secureDocId(t.getDocId()),s=null;if(!i.checkSecuredDocId(n,t.getDocId(),"get"))return;s=e.getItem("jio/local/"+i.secured_username+"/"+i.secured_applicationname+"/"+n),s?(t.getOption("metadata_only")&&delete s.content,r.success(s)):r.error({status:404,statusText:"Not Found.",error:"not_found",message:'Document "'+t.getDocId()+'" not found.',reason:"missing"})})},r.allDocs=function(t){setTimeout(function(){var n=[],s=[],o,u,a="key",f="jio/local/"+i.secured_username+"/"+i.secured_applicationname,l={};s=i.getFileNameArray();for(o=0,u=s.length;o<u;o+=1)l=e.getItem(f+"/"+s[o]),l&&(t.getOption("metadata_only")?n.push({id:l._id,key:l._id,value:{_creation_date:l._creation_date,_last_modified:l._last_modified}}):n.push({id:l._id,key:l._id,value:{content:l.content,_creation_date:l._creation_date,_last_modified:l._last_modified}}));r.success({total_rows:n.length,rows:n})})},r.remove=function(t){setTimeout(function(){var n=i.secureDocId(t.getDocId()),s="jio/local/"+i.secured_username+"/"+i.secured_applicationname+"/"+n;if(!i.checkSecuredDocId(n,t.getDocId(),"remove"))return;e.deleteItem(s),i.removeFileName(n),r.success({ok:!0,id:t.getDocId()})})},r};s.addStorageType("local",o);var u=function(e,r){e=e||{};var i=r.basicStorage(e,r),s={};s.secureDocId=function(e){var t=e.split("/"),n;t[0]===""&&(t=t.slice(1));for(n=0;n<t.length;n+=1)if(t[n]==="")return"";return t.join("%2F")},s.convertSlashes=function(e){return e.split("/").join("%2F")},s.restoreSlashes=function(e){return e.split("%2F").join("/")},s.username=e.username||"",s.secured_username=s.convertSlashes(s.username),s.applicationname=e.applicationname||"untitled",s.secured_applicationname=s.convertSlashes(s.applicationname),s.url=e.url||"",s.password=e.password||"";var o=i.serialized;return i.serialized=function(){var e=o();return e.username=s.username,e.applicationname=s.applicationname,e.url=s.url,e.password=s.password,e},i.validateState=function(){return s.secured_username&&s.url?"":'Need at least 2 parameters: "username" and "url".'},s.newAsyncModule=function(){var e={};return e.call=function(e,t,n){return e._wait=e._wait||{},e._wait[t]?(e._wait[t]--,function(){}):(n=n||[],e[t].apply(e[t],n))},e.neverCall=function(e,t){e._wait=e._wait||{},e._wait[t]=-1},e.wait=function(e,t,n){e._wait=e._wait||{},e._wait[t]=n},e.end=function(){e.call=function(){}},e},s.putOrPost=function(e,r){var o=s.secureDocId(e.getDocId());t.ajax({url:s.url+"/"+s.secured_username+"/"+s.secured_applicationname+"/"+o+"?_="+Date.now(),type:r,data:e.getDocContent(),async:!0,dataType:"text",headers:{Authorization:"Basic "+n.encode(s.username+":"+s.password)},success:function(){i.success({ok:!0,id:e.getDocId()})},error:function(t){t.error=t.statusText,t.reason='Cannot save "'+e.getDocId()+'"',t.message=t.reason+".",i.retry(t)}})},i.post=function(e){s.putOrPost(e,"POST")},i.put=function(e){s.putOrPost(e,"PUT")},i.get=function(e){var r=s.secureDocId(e.getDocId()),o={},u=function(){t.ajax({url:s.url+"/"+s.secured_username+"/"+s.secured_applicationname+"/"+r+"?_="+Date.now(),type:"GET",async:!0,dataType:"text",headers:{Authorization:"Basic "+n.encode(s.username+":"+s.password)},success:function(e){o.content=e,i.success(o)},error:function(t){t.error=t.statusText,t.status===404?(t.message='Document "'+e.getDocId()+'" not found.',t.reason="missing",i.error(t)):(t.reason='An error occured when trying to get "'+e.getDocId()+'"',t.message=t.reason+".",i.retry(t))}})};o._id=e.getDocId(),t.ajax({url:s.url+"/"+s.secured_username+"/"+s.secured_applicationname+"/"+r+"?_="+Date.now(),type:"PROPFIND",async:!0,dataType:"xml",headers:{Authorization:"Basic "+n.encode(s.username+":"+s.password)},success:function(n){t(n).find("lp1\\:getlastmodified, getlastmodified").each(function(){o._last_modified=(new Date(t(this).text())).getTime()}),t(n).find("lp1\\:creationdate, creationdate").each(function(){o._creation_date=(new Date(t(this).text())).getTime()}),e.getOption("metadata_only")?i.success(o):u()},error:function(t){t.status===404?(t.message='Cannot find "'+e.getDocId()+'" informations.',t.reason="missing",i.error(t)):(t.reason='Cannot get "'+e.getDocId()+'" informations',t.message=t.reason+".",i.retry(t))}})},i.allDocs=function(e){var r=[],o=s.newAsyncModule(),u={};u.getContent=function(e){t.ajax({url:s.url+"/"+s.secured_username+"/"+s.secured_applicationname+"/"+s.secureDocId(e.id)+"?_="+Date.now(),type:"GET",async:!0,dataType:"text",headers:{Authorization:"Basic "+n.encode(s.username+":"+s.password)},success:function(t){e.value.content=t,r.push(e),o.call(u,"success")},error:function(e){e.error=e.statusText,e.reason="Cannot get a document content from DAVStorage",e.message=e.message+".",o.call(u,"error",[e])}})},u.getDocumentList=function(){t.ajax({url:s.url+"/"+s.secured_username+"/"+s.secured_applicationname+"/"+"?_="+Date.now(),async:!0,type:"PROPFIND",dataType:"xml",headers:{Authorization:"Basic "+n.encode(s.username+":"+s.password),Depth:"1"},success:function(n){var i=t(n).find("D\\:response, response"),a=i.length;if(a===1)return o.call(u,"success");o.wait(u,"success",a-2),i.each(function(n,i){if(n>0){var a={value:{}};t(i).find("D\\:href, href").each(function(){var e=t(this).text().split("/");a.id=e[e.length-1],a.id=s.restoreSlashes(a.id),a.key=a.id});if(a.id===".htaccess"||a.id===".htpasswd")return;t(i).find("lp1\\:getlastmodified, getlastmodified").each(function(){a.value._last_modified=(new Date(t(this).text())).getTime()}),t(i).find("lp1\\:creationdate, creationdate").each(function(){a.value._creation_date=(new Date(t(this).text())).getTime()}),e.getOption("metadata_only")?(r.push(a),o.call(u,"success")):o.call(u,"getContent",[a])}})},error:function(e){e.status===404?(e.error="not_found",e.reason="missing",o.call(u,"error",[e])):(e.error=e.statusText,e.reason="Cannot get a document list from DAVStorage",e.message=e.reason+".",o.call(u,"retry",[e]))}})},u.retry=function(e){o.neverCall(u,"retry"),o.neverCall(u,"success"),o.neverCall(u,"error"),i.retry(e)},u.error=function(e){o.neverCall(u,"retry"),o.neverCall(u,"success"),o.neverCall(u,"error"),i.error(e)},u.success=function(){o.neverCall(u,"retry"),o.neverCall(u,"success"),o.neverCall(u,"error"),i.success({total_rows:r.length,rows:r})},o.call(u,"getDocumentList")},i.remove=function(e){var r=s.secureDocId(e.getDocId());t.ajax({url:s.url+"/"+s.secured_username+"/"+s.secured_applicationname+"/"+r+"?_="+Date.now(),type:"DELETE",async:!0,headers:{Authorization:"Basic "+n.encode(s.username+":"+s.password)},success:function(t,n,r){i.success({ok:!0,id:e.getDocId()})},error:function(e,t,n){e.status===404?(e.error="not_found",e.reason="missing",e.message="Cannot remove missing file.",i.error(e)):(e.reason='Cannot remove "'+i.getDocId()+'"',e.message=e.reason+".",i.retry(e))}})},i};s.addStorageType("dav",u);var a=function(e,t){e=e||{};var n=t.basicStorage(e,t),r={};r.return_value_array=[],r.storagelist=e.storagelist||[],r.nb_storage=r.storagelist.length;var i=n.serialized;return n.serialized=function(){var e=i();return e.storagelist=r.storagelist,e},n.validateState=function(){return r.storagelist.length===0?'Need at least one parameter: "storagelist" containing at least one storage.':""},r.isTheLast=function(e){return e.length===r.nb_storage},r.doJob=function(e,t,i){var s=!1,o=[],u,a=function(u){s||(o.push(u),r.isTheLast(o)&&n.error({status:207,statusText:"Multi-Status",error:"multi_status",message:"All "+t+(i?" ":' "'+e.getDocId()+'"')+" requests have failed.",reason:"requests fail",array:o}))},f=function(e){s||(s=!0,n.success(e))};for(u=0;u<r.nb_storage;u+=1){var l=e.cloneOption();n.addJob(e.getLabel(),r.storagelist[u],e.cloneDoc(),l,f,a)}},n.post=function(e){r.doJob(e,"post"),n.end()},n.put=function(e){r.doJob(e,"put"),n.end()},n.get=function(e){r.doJob(e,"get"),n.end()},n.allDocs=function(e){r.doJob(e,"allDocs",!0),n.end()},n.remove=function(e){r.doJob(e,"remove"),n.end()},n};s.addStorageType("replicate",a);var f=function(t,n){t=t||{};var r=n.basicStorage(t,n),i={},s=t.storage||!1;i.secondstorage_spec=t.storage||{type:"base"},i.secondstorage_string=JSON.stringify(i.secondstorage_spec);var o="jio/indexed_storage_object",u="jio/indexed_file_object/"+i.secondstorage_string,a=r.serialized;return r.serialized=function(){var e=a();return e.storage=i.secondstorage_spec,e},r.validateState=function(){return s?"":'Need at least one parameter: "storage" containing storage specifications.'},i.secureDocId=function(e){var t=e.split("/"),n;t[0]===""&&(t=t.slice(1));for(n=0;n<t.length;n+=1)if(t[n]==="")return"";return t.join("%2F")},i.indexStorage=function(){var t=e.getItem(o)||{};t[i.secondstorage_spec]=(new Date).getTime(),e.setItem(o,t)},i.formatToFileObject=function(e){var t,n={_id:e.id};for(t in e.value)n[t]=e.value[t];return n},i.allDocs=function(e){var t,n={rows:[]},r=0;for(t in e)n.rows[r]={},n.rows[r].value=e[t],n.rows[r].id=n.rows[r].key=n.rows[r].value._id,delete n.rows[r].value._id,r++;return n.total_rows=n.rows.length,n},i.setFileArray=function(t){var n,r={};for(n=0;n<t.length;n+=1)r[t[n].id]=i.formatToFileObject(t[n]);e.setItem(u,r)},i.getFileObject=function(t){var n=e.getItem(u)||{};return n[t]},i.addFile=function(t){var n=e.getItem(u)||{};n[t._id]=t,e.setItem(u,n)},i.removeFile=function(t){var n=e.getItem(u)||{};delete n[t],e.setItem(u,n)},i.update=function(){var e=function(e){i.setFileArray(e.rows)};r.addJob("allDocs",i.secondstorage_spec,null,{max_retry:3},e,function(){})},r.post=function(e){r.put(e)},r.put=function(e){var t=e.cloneDoc(),n=e.cloneOption(),s=function(e){i.update(),r.success(e)},o=function(e){r.error(e)};i.indexStorage(),r.addJob("put",i.secondstorage_spec,t,n,s,o)},r.get=function(e){var t,n=function(e){r.success(e)},s=function(e){r.error(e)},o=function(){var t=e.cloneOption();r.addJob("get",i.secondstorage_spec,e.cloneDoc(),t,n,s),r.end()};i.indexStorage(),i.update(),e.getOption("metadata_only")?setTimeout(function(){var t=i.getFileObject(e.getDocId());t&&(t._last_modified||t._creation_date)?r.success(t):o()}):o()},r.allDocs=function(t){var n=e.getItem(u);if(n)i.update(),setTimeout(function(){r.success(i.allDocs(n))});else{var s=function(e){i.setFileArray(e.rows),r.success(e)},o=function(e){r.error(e)};r.addJob("allDocs",i.secondstorage_spec,null,t.cloneOption(),s,o)}},r.remove=function(e){var t=function(t){i.removeFile(e.getDocId()),i.update(),r.success(t)},n=function(e){r.error(e)};r.addJob("remove",i.secondstorage_spec,e.cloneDoc(),e.cloneOption(),t,n)},r};s.addStorageType("indexed",f);var l=function(e,n){e=e||{};var i=n.basicStorage(e,n),s={},o=e.storage?!0:!1;s.username=e.username||"",s.password=e.password||"",s.secondstorage_spec=e.storage||{type:"base"},s.secondstorage_string=JSON.stringify(s.secondstorage_string);var u=i.serialized;return i.serialized=function(){var e=u();return e.username=s.username,e.password=s.password,e.storage=s.secondstorage_string,e},i.validateState=function(){return s.username&&o?"":'Need at least two parameters: "username" and "storage".'},s.encrypt_param_object={iv:"kaprWwY/Ucr7pumXoTHbpA",v:1,iter:1e3,ks:256,ts:128,mode:"ccm",adata:"",cipher:"aes",salt:"K4bmZG9d704"},s.decrypt_param_object={iv:"kaprWwY/Ucr7pumXoTHbpA",ks:256,ts:128,salt:"K4bmZG9d704"},s.encrypt=function(e,t){var n=r.encrypt(s.username+":"+s.password,e,s.encrypt_param_object);t(JSON.parse(n).ct)},s.decrypt=function(e,n){var i,o=t.extend(!0,{},s.decrypt_param_object);o.ct=e||"",o=JSON.stringify(o);try{i=r.decrypt(s.username+":"+s.password,o)}catch(u){n({status:403,statusText:"Forbidden",error:"forbidden",message:"Unable to decrypt.",reason:"unable to decrypt"});return}n(undefined,i)},s.newAsyncModule=function(){var e={};return e.call=function(e,t,n){e._wait=e._wait||{};if(e._wait[t])return e._wait[t]--,function(){};n=n||[],setTimeout(function(){e[t].apply(e[t],n)})},e.neverCall=function(e,t){e._wait=e._wait||{},e._wait[t]=-1},e.wait=function(e,t,n){e._wait=e._wait||{},e._wait[t]=n},e.end=function(){e.call=function(){}},e},i.post=function(e){i.put(e)},i.put=function(e){var t,n,r=s.newAsyncModule(),o={};o.encryptFilePath=function(){s.encrypt(e.getDocId(),function(e){t=e,r.call(o,"save")})},o.encryptFileContent=function(){s.encrypt(e.getDocContent(),function(e){n=e,r.call(o,"save")})},o.save=function(){var r=function(t){t.id=e.getDocId(),i.success(t)},o=function(e){i.error(e)},u=e.cloneDoc();u._id=t,u.content=n,i.addJob("put",s.secondstorage_spec,u,e.cloneOption(),r,o)},r.wait(o,"save",1),r.call(o,"encryptFilePath"),r.call(o,"encryptFileContent")},i.get=function(e){var t,n,r=s.newAsyncModule(),o={};o.encryptFilePath=function(){s.encrypt(e.getDocId(),function(e){t=e,r.call(o,"get")})},o.get=function(){i.addJob("get",s.secondstorage_spec,t,e.cloneOption(),o.success,o.error)},o.success=function(t){t._id=e.getDocId(),e.getOption("metadata_only")?i.success(t):s.decrypt(t.content,function(e,n){e?i.error(e):(t.content=n,i.success(t))})},o.error=function(e){i.error(e)},r.call(o,"encryptFilePath")},i.allDocs=function(e){var t=[],n=s.newAsyncModule(),r={};r.allDocs=function(){i.addJob("allDocs",s.secondstorage_spec,null,e.cloneOption(),r.onSuccess,r.error)},r.onSuccess=function(i){if(i.total_rows===0)return n.call(r,"success");t=i.rows;var o,u=function(i){s.decrypt(t[i].id,function(e,s){e?n.call(r,"error",[e]):(t[i].id=s,t[i].key=s,n.call(r,"success"))}),e.getOption("metadata_only")||s.decrypt(t[i].value.content,function(e,s){e?n.call(r,"error",[e]):(t[i].value.content=s,n.call(r,"success"))})};e.getOption("metadata_only")?n.wait(r,"success",i.total_rows*1-1):n.wait(r,"success",i.total_rows*2-1);for(o=0;o<t.length;o+=1)u(o)},r.error=function(e){n.end(),i.error(e)},r.success=function(){n.end(),i.success({total_rows:t.length,rows:t})},n.call(r,"allDocs")},i.remove=function(e){var t,n={};n.encryptDocId=function(){s.encrypt(e.getDocId(),function(e){t=e,n.removeDocument()})},n.removeDocument=function(){var r=e.cloneDoc();r._id=t,i.addJob("remove",s.secondstorage_spec,r,e.cloneOption(),n.success,i.error)},n.success=function(t){t.id=e.getDocId(),i.success(t)},n.encryptDocId()},i};s.addStorageType("crypt",l);var c=function(e,t){e=e||{};var n=t.basicStorage(e,t),r={},s=e.storage?!0:!1;r.secondstorage_spec=e.storage||{type:"base"},r.secondstorage_string=JSON.stringify(r.secondstorage_spec);var o="jio/conflictmanager/"+r.secondstorage_string+"/",u=function(){},a=n.serialized;return n.serialized=function(){var e=a();return e.storage=r.secondstorage_spec,e},n.validateState=function(){return s?"":'Need at least one parameter: "storage".'},r.getDistantMetadata=function(e,t,i,s){var o=e.cloneOption();o.metadata_only=!1,n.addJob("get",r.secondstorage_spec,t,o,i,s)},r.saveMetadataToDistant=function(e,t,i,s,o){n.addJob("put",r.secondstorage_spec,{_id:t,content:JSON.stringify(i)},e.cloneOption(),s,o)},r.saveNewRevision=function(e,t,i,s,o){n.addJob("post",r.secondstorage_spec,{_id:t,content:i},e.cloneOption(),s,o)},r.loadRevision=function(e,t,i,s){n.addJob("get",r.secondstorage_spec,t,e.cloneOption(),i,s)},r.deleteAFile=function(e,t,i,s){var o=e.cloneOption();n.addJob("remove",r.secondstorage_spec,{_id:t},e.cloneOption(),i,s)},r.chooseARevision=function(e){var t=0,n="",r;for(r in e)t<e[r]._last_modified&&(t=e[r]._last_modified,n=r);return n},r._revs=function(e,t){return!e||!t?null:e[t]?{start:e[t]._revisions.length,ids:e[t]._revisions}:null},r._revs_info=function(e){if(!e)return null;var t,n=[];for(t in e)n.push({rev:t,status:e[t]?e[t]._deleted?"deleted":"available":"missing"});return n},r.solveConflict=function(e,t,n){var s={},o=r.newAsyncModule(),a=n.command,f=n.docid+".metadata",l="",c="",h=null,p=!1,d={total_rows:0,rows:[]},v=n._deleted,m=n.previous_revision,g=null,y=new Date,b;s.getDistantMetadata=function(){r.getDistantMetadata(a,f,function(t){var r=parseInt(m.split("-")[0],10);h=JSON.parse(t.content),l=r+1+"-"+i(""+e.content+m+JSON.stringify(h)),c=n.docid+"."+l,g=h[m]||{},v||(o.wait(s,"saveMetadataOnDistant",1),o.call(s,"saveNewRevision")),o.call(s,"previousUpdateMetadata")},function(e){o.call(s,"error",[e])})},s.saveNewRevision=function(){r.saveNewRevision(a,c,e.content,function(e){o.call(s,"saveMetadataOnDistant")},function(e){o.call(s,"error",[e])})},s.previousUpdateMetadata=function(){var e;for(e=0;e<n.key.length;e+=1)delete h[n.key[e]];o.call(s,"checkForConflicts")},s.checkForConflicts=function(){var e;for(e in h){var t;p=!0,b={status:409,error:"conflict",statusText:"Conflict",reason:"document update conflict",message:"There is one or more conflicts"};break}o.call(s,"updateMetadata")},s.updateMetadata=function(){var e,t="";t=l.split("-"),t.shift(),t=t.join("-"),e=g._revisions,e.unshift(t),h[l]={_creation_date:g._creation_date||y.getTime(),_last_modified:y.getTime(),_revisions:e,_conflict:p,_deleted:v},p&&(d=r.createConflictObject(a,h,l)),o.call(s,"saveMetadataOnDistant")},s.saveMetadataOnDistant=function(){r.saveMetadataToDistant(a,f,h,function(e){o.call(s,"deleteAllConflictingRevision"),p?o.call(s,"error"):o.call(s,"success")},function(e){o.call(s,"error",[e])})},s.deleteAllConflictingRevision=function(){var e;for(e=0;e<n.key.length;e+=1)r.deleteAFile(a,n.docid+"."+n.key[e],u,u)},s.success=function(){var e={ok:!0,id:n.docid,rev:l};o.neverCall(s,"error"),o.neverCall(s,"success"),t.revs&&(e.revisions=r._revs(h,l)),t.revs_info&&(e.revs_info=r._revs_info(h)),t.conflicts&&(e.conflicts=d),n.success(e)},s.error=function(e){var i=e||b||{status:0,statusText:"Unknown",error:"unknown_error",message:"Unknown error.",reason:"unknown error"};l&&(i.rev=l),t.revs&&(i.revisions=r._revs(h,l)),t.revs_info&&(i.revs_info=r._revs_info(h)),t.conflicts&&(i.conflicts=d),o.neverCall(s,"error"),o.neverCall(s,"success"),n.error(i)},o.call(s,"getDistantMetadata")},r.createConflictObject=function(e,t,n){return{total_rows:1,rows:[r.createConflictRow(e,e.getDocId(),t,n)]}},r.getParam=function(e){var t={},n=0;return typeof e[n]=="string"&&(t.content=e[n],n++),typeof e[n]=="object"?(t.options=e[n],n++):t.options={},t.callback=function(e,t){},t.success=function(e){t.callback(undefined,e)},t.error=function(e){t.callback(e,undefined)},typeof e[n]=="function"&&(typeof e[n+1]=="function"?(t.success=e[n],t.error=e[n+1]):t.callback=e[n]),t},r.createConflictRow=function(e,t,n,i){var s={id:t,key:[],value:{_solveConflict:function(){var n={},o=r.getParam(arguments);return o.content===undefined?n._deleted=!0:n._deleted=!1,n.success=o.success,n.error=o.error,n.previous_revision=i,n.docid=t,n.key=s.key,n.command=e.clone(),r.solveConflict({_id:t,content:o.content,_rev:i},o.options,n)}}},o;for(o in n)s.key.push(o);return s},r.newAsyncModule=function(){var e={};return e.call=function(e,t,n){e._wait=e._wait||{};if(e._wait[t])return e._wait[t]--,u;n=n||[],setTimeout(function(){e[t].apply(e[t],n)})},e.neverCall=function(e,t){e._wait=e._wait||{},e._wait[t]=-1},e.wait=function(e,t,n){e._wait=e._wait||{},e._wait[t]=n},e.end=function(){e.call=u},e},n.post=function(e){n.put(e)},n.put=function(e){var t={},s=r.newAsyncModule(),o=e.getDocId()+".metadata",a="",f="",l=null,c=!1,h={total_rows:0,rows:[]},p=e.getDocInfo("_rev")||"0",d=e.getDocId()+"."+p,v=new Date,m;t.getDistantMetadata=function(){r.getDistantMetadata(e,o,function(n){var r=parseInt(p.split("-")[0],10);l=JSON.parse(n.content),a=r+1+"-"+i(""+e.getDocContent()+p+JSON.stringify(l)),f=e.getDocId()+"."+a,s.wait(t,"saveMetadataOnDistant",1),s.call(t,"saveNewRevision"),s.call(t,"checkForConflicts")},function(n){n.status===404?(a="1-"+i(e.getDocContent()),f=e.getDocId()+"."+a,s.wait(t,"saveMetadataOnDistant",1),s.call(t,"saveNewRevision"),s.call(t,"createMetadata")):s.call(t,"error",[n])})},t.saveNewRevision=function(){r.saveNewRevision(e,f,e.getDocContent(),function(e){s.call(t,"saveMetadataOnDistant")},function(e){s.call(t,"error",[e])})},t.checkForConflicts=function(){var e;for(e in l)if(e!==p){c=!0,m={status:409,error:"conflict",statusText:"Conflict",reason:"document update conflict",message:"Document update conflict."};break}s.call(t,"updateMetadata")},t.createMetadata=function(){var e=a;e=e.split("-"),e.shift(),e=e.join("-"),l={},l[a]={_creation_date:v.getTime(),_last_modified:v.getTime(),_revisions:[e],_conflict:!1,_deleted:!1},s.call(t,"saveMetadataOnDistant")},t.updateMetadata=function(){var n,i=[],o="";l[p]&&(n=l[p]._creation_date,i=l[p]._revisions,delete l[p]),o=a.split("-"),o.shift(),o=o.join("-"),i.unshift(o),l[a]={_creation_date:n||v.getTime(),_last_modified:v.getTime(),_revisions:i,_conflict:c,_deleted:!1},c&&(h=r.createConflictObject(e,l,a)),s.call(t,"saveMetadataOnDistant")},t.saveMetadataOnDistant=function(){r.saveMetadataToDistant(e,o,l,function(e){s.call(t,"deletePreviousRevision"),c?s.call(t,"error"):s.call(t,"success")},function(e){s.call(t,"error",[e])})},t.deletePreviousRevision=function(){p!=="0"&&r.deleteAFile(e,d,u,u)},t.success=function(){var i={ok:!0,id:e.getDocId(),rev:a};s.neverCall(t,"error"),s.neverCall(t,"success"),e.getOption("revs")&&(i.revisions=r._revs(l,a)),e.getOption("revs_info")&&(i.revs_info=r._revs_info(l)),e.getOption("conflicts")&&(i.conflicts=h),n.success(i)},t.error=function(i){var o=i||m||{status:0,statusText:"Unknown",error:"unknown_error",message:"Unknown error.",reason:"unknown error"};a&&(o.rev=a),e.getOption("revs")&&(o.revisions=r._revs(l,a)),e.getOption("revs_info")&&(o.revs_info=r._revs_info(l)),e.getOption("conflicts")&&(o.conflicts=h),s.neverCall(t,"error"),s.neverCall(t,"success"),n.error(o)},s.call(t,"getDistantMetadata")},n.get=function(e){var t={},i=r.newAsyncModule(),s=e.getDocId()+".metadata",o=e.getOption("rev")||"",u=null,a=e.getOption("metadata_only"),f=!1,l={total_rows:0,rows:[]},c=new Date,h={_id:e.getDocId()},p=function(e){i.call(t,"error",[{status:404,statusText:"Not Found",error:"not_found",message:e,reason:e}])};t.getDistantMetadata=function(){r.getDistantMetadata(e,s,function(e){u=JSON.parse(e.content),a||i.wait(t,"success",1),i.call(t,"affectMetadata"),i.call(t,"checkForConflicts")},function(e){i.call(t,"error",[e])})},t.affectMetadata=function(){if(o){if(!u[o])return p("Document revision does not exists.")}else o=r.chooseARevision(u);h._last_modified=u[o]._last_modified,h._creation_date=u[o]._creation_date,h._rev=o,a?i.call(t,"success"):i.call(t,"loadRevision")},t.loadRevision=function(){if(!o||u[o]._deleted)return p("Document has been removed.");r.loadRevision(e,h._id+"."+o,function(e){h.content=e.content,i.call(t,"success")},function(e){i.call(t,"error",[e])})},t.checkForConflicts=function(){u[o]._conflict&&(f=!0,l=r.createConflictObject(e,u,o)),i.call(t,"success")},t.success=function(){i.neverCall(t,"error"),i.neverCall(t,"success"),e.getOption("revs")&&(h._revisions=r._revs(u,o)),e.getOption("revs_info")&&(h._revs_info=r._revs_info(u)),e.getOption("conflicts")&&(h._conflicts=l),n.success(h)},t.error=function(s){var a=s||{status:0,statusText:"Unknown",message:"Unknown error."};e.getOption("revs")&&(a._revisions=r._revs(u,o)),e.getOption("revs_info")&&(a._revs_info=r._revs_info(u)),e.getOption("conflicts")&&(a._conflicts=l),i.neverCall(t,"error"),i.neverCall(t,"success"),n.error(a)},i.call(t,"getDistantMetadata")},n.allDocs=function(e){var t={},i=r.newAsyncModule(),s=e.getOption("metadata_only"),o=[],u={total_rows:0,rows:[]},a=0,f=0,l=0;t.retreiveList=function(){var s=e.cloneOption(),o=function(e){i.call(t,"filterTheList",[e])},u=function(e){i.call(t,"error",[e])};s.metadata_only=!0,n.addJob("allDocs",r.secondstorage_spec,null,s,o,u)},t.filterTheList=function(e){var n;l++;for(n=0;n<e.total_rows;n+=1){var r=e.rows[n].id.split(".")||[];r.length>0&&r[r.length-1]==="metadata"&&(l++,r.length--,i.call(t,"loadMetadataFile",[r.join(".")]))}i.call(t,"success")},t.loadMetadataFile=function(n){r.getDistantMetadata(e,n+".metadata",function(e){e=JSON.parse(e.content);var s=r.chooseARevision(e);e[s]._deleted?i.call(t,"success"):i.call(t,"loadFile",[n,s,e])},function(e){i.call(t,"error",[e])})},t.loadFile=function(n,a,f){var l={id:n,key:n,value:{_last_modified:f[a]._last_modified,_creation_date:f[a]._creation_date,_rev:a}};e.getOption("revs")&&(l.value._revisions=r._revs(f,a)),e.getOption("revs_info")&&(l.value._revs_info=r._revs_info(f,a)),e.getOption("conflicts")&&f[a]._conflict&&(u.total_rows++,u.rows.push(r.createConflictRow(e,n,f,a))),s?(o.push(l),i.call(t,"success")):r.loadRevision(e,n+"."+a,function(e){l.content=e.content,o.push(l),i.call(t,"success")},function(e){i.call(t,"error",[e])})},t.success=function(){var t;f++,f>=l&&(i.end(),t={total_rows:o.length,rows:o},e.getOption("conflicts")&&(t.conflicts=u),n.success(t))},t.error=function(e){i.end(),n.error(e)},i.call(t,"retreiveList")},n.remove=function(e){var t={},s=r.newAsyncModule(),o=e.getDocId()+".metadata",a="",f="",l=null,c=!1,h={total_rows:0,rows:[]},p=e.getOption("rev")||"0",d=e.getDocId()+"."+p,v=new Date,m;t.getDistantMetadata=function(){r.getDistantMetadata(e,o,function(n){l=JSON.parse(n.content),p==="last"&&(p=r.chooseARevision(l),d=e.getDocId()+"."+p);var o=parseInt(p.split("-")[0],10)||0;a=o+1+"-"+i(""+p+JSON.stringify(l)),f=e.getDocId()+"."+a,s.call(t,"checkForConflicts")},function(e){e.status===404?s.call(t,"error",[{status:404,statusText:"Not Found",error:"not_found",reason:"missing",message:"Document not found."}]):s.call(t,"error",[e])})},t.checkForConflicts=function(){var e;for(e in l)if(e!==p){c=!0,m={status:409,error:"conflict",statusText:"Conflict",reason:"document update conflict",message:"There is one or more conflicts"};break}s.call(t,"updateMetadata")},t.updateMetadata=function(){var n,i=[],o="";l[p]&&(n=l[p]._creation_date,i=l[p]._revisions,delete l[p]),o=a,o=o.split("-"),o.shift(),o=o.join("-"),i.unshift(o),l[a]={_creation_date:n||v.getTime(),_last_modified:v.getTime(),_revisions:i,_conflict:c,_deleted:!0},c&&(h=r.createConflictObject(e,l,a)),s.call(t,"saveMetadataOnDistant")},t.saveMetadataOnDistant=function(){r.saveMetadataToDistant(e,o,l,function(e){s.call(t,"deletePreviousRevision"),c?s.call(t,"error"):s.call(t,"success")},function(e){s.call(t,"error",[e])})},t.deletePreviousRevision=function(){p!=="0"&&r.deleteAFile(e,d,u,u)},t.success=function(i){var o={ok:!0,id:e.getDocId(),rev:i||a};s.neverCall(t,"error"),s.neverCall(t,"success"),e.getOption("revs")&&(o.revisions=r._revs(l,a)),e.getOption("revs_info")&&(o.revs_info=r._revs_info(l)),e.getOption("conflicts")&&(o.conflicts=h),n.success(o)},t.error=function(i){var o=i||m||{status:0,statusText:"Unknown",error:"unknown_error",message:"Unknown error.",reason:"unknown error"};a&&(o.rev=a),e.getOption("revs")&&(o.revisions=r._revs(l,a)),e.getOption("revs_info")&&(o.revs_info=r._revs_info(l)),e.getOption("conflicts")&&(o.conflicts=h),s.neverCall(t,"error"),s.neverCall(t,"success"),n.error(o)},s.call(t,"getDistantMetadata")},n};s.addStorageType("conflictmanager",c)})(LocalOrCookieStorage,jQuery,Base64,sjcl,hex_sha256,jIO);